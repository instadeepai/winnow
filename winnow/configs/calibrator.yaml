# --- Calibrator configuration ---

# Shared Koina model inputs â€” applied to all intensity-based features (FragmentMatchFeatures, ChimericFeatures).
# To use a constant value tiled across all rows, specify it under koina_model_input_constants.
# To use per-row values from a metadata column, add the column mapping under koina_model_input_columns.
# Each input key must appear in at most one of these two dicts.
koina_model_input_constants:
  collision_energies: 25
  fragmentation_types: HCD
# koina_model_input_columns: {}

# Shared Koina model constraints.
# Adjust to match the capabilities of your configured Koina models.
# See docs/configuration.md for guidance on choosing these values.
koina_model_constraints:
  max_precursor_charge: 6   # Maximum precursor charge accepted by the Koina intensity models.
  max_peptide_length: 30    # Maximum peptide length (residue token count) accepted by the Koina intensity/iRT models.

calibrator:
  _target_: winnow.calibration.calibrator.ProbabilityCalibrator

  seed: 42
  hidden_layer_sizes: [50, 50]  # The number of neurons in each hidden layer of the MLP classifier.
  learning_rate_init: 0.001  # The initial learning rate for the MLP classifier.
  alpha: 0.0001  # L2 regularisation parameter for the MLP classifier.
  max_iter: 1000  # Maximum number of training iterations for the MLP classifier.
  early_stopping: true  # Whether to use early stopping to terminate training.
  validation_fraction: 0.1  # Proportion of training data to use for early stopping validation.

  features:
    mass_error:
      _target_: winnow.calibration.calibration_features.MassErrorFeature
      residue_masses: ${residue_masses}  # The residue masses to use for the mass error feature.

    fragment_match_features:
      _target_: winnow.calibration.calibration_features.FragmentMatchFeatures
      mz_tolerance: 0.02
      learn_from_missing: false  # If True, impute missing features and add an indicator column. If False, filter invalid entries with a warning.
      unsupported_residues: ${unsupported_residues}  # Residues unsupported by the configured Koina intensity model.
      intensity_model_name: Prosit_2025_intensity_22PTM  # The name of the Koina intensity model to use.
      max_precursor_charge: ${koina_model_constraints.max_precursor_charge}  # Maximum precursor charge accepted by the Koina intensity model.
      max_peptide_length: ${koina_model_constraints.max_peptide_length}      # Maximum peptide length accepted by the Koina intensity model.
      model_input_constants: ${koina_model_input_constants}  # Shared Koina model inputs (e.g. collision_energies, fragmentation_types).
      # model_input_columns: ${koina_model_input_columns}  # Uncomment to use per-row metadata columns instead.

    retention_time_feature:
      _target_: winnow.calibration.calibration_features.RetentionTimeFeature
      hidden_dim: 10  # The hidden dimension size for the MLP regressor used to predict iRT from observed retention times.
      train_fraction: 0.1  # The fraction of the data to use for training the iRT predictor.
      learn_from_missing: false  # If True, impute missing features and add an indicator column. If False, filter invalid entries with a warning.
      seed: 42  # Random seed for the MLP regressor.
      learning_rate_init: 0.001  # The initial learning rate for the MLP regressor.
      alpha: 0.0001  # L2 regularisation parameter for the MLP regressor.
      max_iter: 200  # Maximum number of training iterations for the MLP regressor.
      early_stopping: true  # Whether to use early stopping for the MLP regressor.
      validation_fraction: 0.1  # Proportion of training data to use for early stopping validation.
      unsupported_residues: ${unsupported_residues}  # Residues unsupported by the configured Koina iRT model.
      irt_model_name: Prosit_2025_irt_22PTM  # The name of the Koina iRT model to use.
      max_peptide_length: ${koina_model_constraints.max_peptide_length}      # Maximum peptide length accepted by the Koina iRT model.

    chimeric_features:
      _target_: winnow.calibration.calibration_features.ChimericFeatures
      mz_tolerance: 0.02
      learn_from_missing: false  # If True, impute missing features and add an indicator column. If False, filter invalid entries with a warning.
      invalid_prosit_residues: ${unsupported_residues}  # Residues unsupported by the configured Koina intensity model.
      prosit_intensity_model_name: Prosit_2025_intensity_22PTM  # The name of the Koina intensity model to use.
      max_precursor_charge: ${koina_model_constraints.max_precursor_charge}  # Maximum precursor charge accepted by the Koina intensity model. Applied to the runner-up sequence.
      max_peptide_length: ${koina_model_constraints.max_peptide_length}      # Maximum peptide length accepted by the Koina intensity model. Applied to the runner-up (second-best) sequence.
      model_input_constants: ${koina_model_input_constants}  # Shared Koina model inputs (e.g. collision_energies, fragmentation_types).
      # model_input_columns: ${koina_model_input_columns}  # Uncomment to use per-row metadata columns instead.

    beam_features:
      _target_: winnow.calibration.calibration_features.BeamFeatures
