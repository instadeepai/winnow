# --- Calibrator configuration ---

calibrator:
  _target_: winnow.calibration.calibrator.ProbabilityCalibrator

  seed: 42
  hidden_layer_sizes: [50, 50]  # The number of neurons in each hidden layer of the MLP classifier.
  learning_rate_init: 0.001  # The initial learning rate for the MLP classifier.
  alpha: 0.0001  # L2 regularisation parameter for the MLP classifier.
  max_iter: 1000  # Maximum number of training iterations for the MLP classifier.
  early_stopping: true  # Whether to use early stopping to terminate training.
  validation_fraction: 0.1  # Proportion of training data to use for early stopping validation.

  features:
    mass_error:
      _target_: winnow.calibration.calibration_features.MassErrorFeature
      residue_masses: ${residue_masses}  # The residue masses to use for the mass error feature.

    fragment_match_features:
      _target_: winnow.calibration.calibration_features.FragmentMatchFeatures
      mz_tolerance: 0.02
      learn_from_missing: false  # If True, impute missing features and add an indicator column. If False, filter invalid entries with a warning.
      intensity_model_name: ${koina.intensity_model}  # The name of the Koina intensity model to use.
      max_precursor_charge: ${koina.constraints.max_precursor_charge}  # Maximum precursor charge accepted by the Koina intensity model.
      max_peptide_length: ${koina.constraints.max_peptide_length}      # Maximum peptide length accepted by the Koina intensity model.
      unsupported_residues: ${koina.constraints.unsupported_residues}  # Residues unsupported by the configured Koina intensity model.
      model_input_constants: ${koina.input_constants}  # Shared Koina model inputs (e.g. collision_energies, fragmentation_types).
      # model_input_columns: ${koina.input_columns}  # Uncomment to use per-row metadata columns instead.

    retention_time_feature:
      _target_: winnow.calibration.calibration_features.RetentionTimeFeature
      hidden_dim: 10  # The hidden dimension size for the MLP regressor used to predict iRT from observed retention times.
      train_fraction: 0.1  # The fraction of the data to use for training the iRT predictor.
      learn_from_missing: false  # If True, impute missing features and add an indicator column. If False, filter invalid entries with a warning.
      seed: 42  # Random seed for the MLP regressor.
      learning_rate_init: 0.001  # The initial learning rate for the MLP regressor.
      alpha: 0.0001  # L2 regularisation parameter for the MLP regressor.
      max_iter: 200  # Maximum number of training iterations for the MLP regressor.
      early_stopping: true  # Whether to use early stopping for the MLP regressor.
      validation_fraction: 0.1  # Proportion of training data to use for early stopping validation.
      irt_model_name: ${koina.irt_model}  # The name of the Koina iRT model to use.
      max_peptide_length: ${koina.constraints.max_peptide_length}      # Maximum peptide length accepted by the Koina iRT model.
      unsupported_residues: ${koina.constraints.unsupported_residues}  # Residues unsupported by the configured Koina iRT model.

    chimeric_features:
      _target_: winnow.calibration.calibration_features.ChimericFeatures
      mz_tolerance: 0.02
      learn_from_missing: false  # If True, impute missing features and add an indicator column. If False, filter invalid entries with a warning.
      prosit_intensity_model_name: ${koina.intensity_model}  # The name of the Koina intensity model to use.
      max_precursor_charge: ${koina.constraints.max_precursor_charge}  # Maximum precursor charge accepted by the Koina intensity model. Applied to the runner-up sequence.
      max_peptide_length: ${koina.constraints.max_peptide_length}      # Maximum peptide length accepted by the Koina intensity model. Applied to the runner-up (second-best) sequence.
      unsupported_residues: ${koina.constraints.unsupported_residues}  # Residues unsupported by the configured Koina intensity model.
      model_input_constants: ${koina.input_constants}  # Shared Koina model inputs (e.g. collision_energies, fragmentation_types).
      # model_input_columns: ${koina.input_columns}  # Uncomment to use per-row metadata columns instead.

    beam_features:
      _target_: winnow.calibration.calibration_features.BeamFeatures


# Koina model configuration — shared settings for all intensity- and iRT-based features.
koina:
  # Model names
  intensity_model: Prosit_2025_intensity_22PTM
  irt_model: Prosit_2025_irt_22PTM

  # Model inputs — applied to FragmentMatchFeatures and ChimericFeatures.
  # To use a constant value tiled across all rows, specify it under input_constants.
  # To use per-row values from a metadata column, add the column mapping under input_columns.
  # Each input key must appear in at most one of these two dicts.
  input_constants:
    collision_energies: 27
    fragmentation_types: HCD
  input_columns: {}

  # Model constraints — adjust to match the capabilities of your Koina models.
  # See docs/configuration.md for guidance on choosing these values.
  constraints:
    max_precursor_charge: 6   # Maximum precursor charge accepted by the intensity models.
    max_peptide_length: 30    # Maximum peptide length (residue token count) accepted by the intensity/iRT models.
    # Residues unsupported by the configured Koina models.
    # These residues must be specified using UNIMOD PTM IDs.
    # Check that all PTMs unsupported by your selected Koina models but supported by Winnow are included.
    unsupported_residues:
      # Residue modifications (amino acid + modification)
      # - "N[UNIMOD:7]"   # Deamidated asparagine
      # - "Q[UNIMOD:7]"   # Deamidated glutamine
      # - "R[UNIMOD:7]"   # Arginine citrullination
      # - "P[UNIMOD:35]"  # Proline hydroxylation
      # - "S[UNIMOD:21]"  # Phosphorylated serine
      # - "T[UNIMOD:21]"  # Phosphorylated threonine
      # - "Y[UNIMOD:21]"  # Phosphorylated tyrosine
      # - "C[UNIMOD:312]"  # Cysteinylation
      # - "E[UNIMOD:27]"  # Pyro-glutamine
      # - "Q[UNIMOD:28]"  # Pyro-glutamine
      # N-terminal modifications (standalone tokens)
      # - "[UNIMOD:1]"    # N-terminal acetylation
      - "[UNIMOD:5]"    # N-terminal carbamylation
      - "[UNIMOD:385]"  # N-terminal ammonia loss
      - "(+25.98)"      # Carbamylation & NH3 loss (legacy notation)
      # Unsupported residues
      # - "C"  # Unmodified cysteine (must be explicitly carbamidomethylated for some Koina models)
